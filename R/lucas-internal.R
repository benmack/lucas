#' Utilities for Land cover/use statistics (LUCAS) data provided by EUROSTAT
#'
#' This package can be used to download the LUCAS Micro Data (LMD) and convert it into a spatial data set.  
#' @import rgdal
#' @import rgeos 
#' @import sp
#' @docType package
#' @name lucas
NULL

.transect_cols_as_factor <- function(lmd) {
  cols_tr <- colnames_transect(lmd)
  u <- unique(unlist(lapply(lmd[, cols_tr], unique)))
  u <- u[!u%in%c("", NA)]
  u <- sort(u)
  for (cln in cols_tr) {
    cl <- as.character(lmd[, cln])
    cl[cl==""] = NA
    lmd[, cln] <- factor(cl, levels=u, labels=u)
  }
  return(lmd)
}

.get_lmd_fname <- function(country, year, ext="xls") {
  fn <- paste0(country, "_", year)
  if (year==2006) {
    fn <- paste0(fn, "_0")
  }
  if (year == 2015 & ext=="xls")
    ext <- "csv"
  if (!is.null(ext))
    fn <- paste0(fn, ".", ext)
  return(fn)
}

.get_lmd_url <- function(country, year) {
  if (year == 2015) {
    fn <- .get_lmd_fname(country, paste0(year, "_20160728"), ext="csv")
  } else {
    fn <- .get_lmd_fname(country, year, ext="xls")
  }
  base_url <- "http://ec.europa.eu/eurostat/documents/205002/"
  year_dir <- c("2006"="209869/",
                "2009"="208938/",
                "2012"="208012/",
                "2015"="6786255/")
  url <- paste0(base_url, year_dir[as.character(year)], fn)
  return(url)
}
#http://ec.europa.eu/eurostat/documents/205002/6786255/DE_2015_20160728.csv/f3b878d5-5c1d-439d-8e91-3e2ba69fdcbf
# par_lmd$lat and par_lmd$long are the coordinate columns
# There is a difference in some points if you use 
# GPS_X_LONG/GPS_Y_LAT or X_LONG/Y_LAT
# In any case, for the 2006 data only GPS_LONG/GPS_LAT are 
# available. The column names are converted to par_lmd names
# when read_lmd is called. i.e. already when downloading with
# a cols parameter.

par_lmd <- list(
  lat="Y_LAT", 
  long="X_LONG"
)

lmd_subsets <- 
  list(a=c("POINT_ID", par_lmd$lat, par_lmd$long, "EW",
           "LC1", "LU1"),
       b=c("LC1",
           "LC2",
           "LU1",
           "LU2",
           "LC1_SPECIES",
           "LC1_PERCENT",
           "LC2_SPECIES",
           "LC2_PERCENT",
           "OBSERVED",
           "OBS_DIST",
           "OBS_TYPE", 
           "AREA_SIZE", 
           "OBS_RADIUS", # 1: 1.5m, 2: 20m
           "LC_LU_SPECIAL_REMARK",
           "WM_WATER_MNGT",
           "WM_SRC_IRRIGATION",
           "WM_TYP_IRRIGATION",
           "WM_DELIVERY_SYST",
           "SOIL_SURVEY",
           "SOIL_PLOUGH",
           "SOIL_CROP",
           "SOIL_STONES",
           "FEATURE_WIDTH",
           "POINT_ID", 
           par_lmd$lat, 
           par_lmd$long,
           "EW")
  )

.Random.seed <-
  c(403L, 10L, -484515832L, -1003072501L, 869265641L, 428093368L, 
    -379402138L, 1107212545L, 348229523L, -389300158L, 1008863220L, 
    650433015L, 1646613997L, 626038404L, -1859213142L, -1403783659L, 
    1334020783L, 306995382L, -869974304L, 1827070499L, 647810369L, 
    -2021863376L, 1301375566L, -1422946631L, 1852029643L, 223845242L, 
    -931206532L, -565297473L, -1329420395L, 446578604L, 623345026L, 
    615596893L, -1375547817L, -1004368578L, -196821640L, -1767461285L, 
    -1667987015L, 52591624L, 2056521398L, -1220487695L, -501634013L, 
    220947570L, 1308440260L, -195669881L, -2038598563L, 1049901652L, 
    1916039290L, -306293819L, -200751841L, -1707621210L, -801384912L, 
    -134640429L, -342842639L, 1380315680L, 255014078L, 176423113L, 
    -1199537541L, -661796790L, -333776724L, 756080559L, 1488522085L, 
    491561244L, -817526414L, -551118355L, -169202137L, -1679294898L, 
    -581639512L, 1343004843L, 2124933577L, 1148626392L, -1248193402L, 
    1190639969L, -1473897229L, -1224940702L, -535466540L, -2069059369L, 
    1134213837L, -1569469852L, 1497759818L, -876419659L, -178632433L, 
    426374678L, 1478447296L, -1199847805L, 1850172065L, -182950768L, 
    -1872990354L, -913184487L, -1929958997L, -916592742L, 158496604L, 
    757442143L, 572667445L, 1724544460L, 1183241506L, 743260029L, 
    425841783L, -1455609442L, -1772257192L, 1618681275L, -1733684391L, 
    -1152540440L, 753180950L, -1504181615L, -124801213L, -588625326L, 
    476789988L, 882648871L, -344898691L, 250508916L, 1614358618L, 
    954306725L, 838128319L, 335022406L, 51863504L, -1608312333L, 
    600536337L, -1344065216L, -1709727458L, -155298327L, 2048300827L, 
    1682972970L, -90867124L, -1173363185L, 1960167749L, -793357572L, 
    -600258222L, 851238605L, 615921287L, -1982570130L, 402455368L, 
    -169754805L, 1288177321L, 1048812536L, 216556326L, -1519713215L, 
    -731707949L, -2107562110L, -1949897804L, 1458266935L, 1674142253L, 
    803652L, -586291094L, 1780765397L, -149803921L, -1812109962L, 
    -595194208L, 1831144291L, 651141121L, -1741001872L, -317766898L, 
    2133294457L, 554408203L, -600094150L, 19554620L, -499028353L, 
    65189333L, 1429908460L, 678808898L, -1551912291L, -1344512233L, 
    -1372864898L, 522501688L, -1774663397L, 1060548217L, -1792939320L, 
    -1607722250L, -1172860111L, 1004487523L, -1394271950L, 1227565700L, 
    -920992057L, -899805795L, -1985165036L, 760407994L, -278277627L, 
    713262047L, 1594178150L, -874727952L, -955059437L, -589947727L, 
    714710880L, -1971700482L, -1000727415L, 807541691L, 912094602L, 
    1452545132L, -1499058705L, -461953499L, 274031324L, 1525037234L, 
    -1180730451L, -943898777L, -790958962L, 428435816L, -1449502357L, 
    -1893319927L, -649179752L, -1021256506L, 2103297569L, -1586534733L, 
    -706589662L, 519853588L, 9357975L, -65461107L, 1249323428L, 1275892618L, 
    -598032395L, -906695089L, 768530774L, -320166912L, 149237059L, 
    1258406113L, -922248624L, -1893480786L, -315362727L, -973628821L, 
    82743258L, 1721413788L, -1103617377L, 11620597L, -1564460660L, 
    -1769982878L, -1157729219L, 544716471L, 274224478L, -288719720L, 
    1873217531L, 1815768473L, -1957143412L, 159731040L, 2018926818L, 
    -1495304024L, -223911220L, -1452784132L, 84064178L, 1787686896L, 
    1197063620L, -1686836904L, 1829121402L, -649716304L, -1358767684L, 
    1228008020L, 2001554882L, -832050400L, -291009604L, -825052080L, 
    1220229090L, 638884712L, 6793036L, 1982495484L, 30798578L, -360410880L, 
    -1318407052L, 458963464L, -895884870L, -532670000L, 1241977836L, 
    -323225708L, -1830148910L, 1507569760L, -212084404L, 2143551264L, 
    -494730622L, -334646808L, 1722745836L, 1907015228L, -1966968206L, 
    -1802504336L, 645218596L, 1868611128L, -748581478L, -1120496176L, 
    790245820L, 227629716L, -155019646L, 383752640L, -1898864836L, 
    1588536976L, -1228840158L, -1469075960L, 449111820L, -748011620L, 
    -973735918L, 1765155712L, -498106604L, -1375573720L, 658184250L, 
    -843036720L, -1573985684L, 951936052L, -1777423214L, 431723872L, 
    -1824259764L, -1946615328L, 780662690L, -187637848L, -1100436340L, 
    -1019155524L, -1912438670L, 741389296L, -1001627580L, 1932801112L, 
    194947130L, 139182192L, 1795910204L, 1914071828L, -883769662L, 
    -1712218400L, 1950344316L, 359215312L, 2070627234L, 1058423336L, 
    -1207083764L, 1248791484L, -1491210958L, 197223616L, 111345204L, 
    -28490040L, 559828666L, -359135088L, 1160735468L, -1203797420L, 
    1376315026L, 1569585952L, -900023348L, -233401120L, -1512744254L, 
    1560330280L, 712795052L, 866243260L, -1197023758L, 727068208L, 
    1983006628L, -1648532040L, -1906997414L, -144127856L, 1988936572L, 
    -164816108L, 190996802L, -1891745024L, 1728489404L, 2101789520L, 
    659057954L, 730625608L, -776386548L, 1246652508L, 1857335762L, 
    -708652544L, -1503389356L, 1902888168L, 1648606458L, 965418704L, 
    -1975540436L, -1689900812L, 1647627666L, 140833120L, 1376948236L, 
    1783322336L, 617155170L, -2067552600L, 825312844L, 1330701180L, 
    -1491770062L, 49387120L, -1137497276L, -1000053800L, 1812098938L, 
    -610604496L, -1533137988L, -1825090988L, -110255038L, 1422033056L, 
    -1976821060L, -377602608L, 1726809954L, 76663528L, -239881012L, 
    -1249473028L, 1982609906L, 735213184L, 1242461684L, 787681928L, 
    754892602L, -54263984L, 918928492L, 1077998996L, -2115926958L, 
    1909660128L, 1234619596L, 545261728L, 675793282L, 1010456808L, 
    -646710548L, 324986172L, 961029234L, 1600638064L, 884143140L, 
    1396117560L, -618863846L, 2006492368L, 1296044860L, 1820327828L, 
    1062008706L, -228037184L, -2113293764L, 651352464L, -1644113374L, 
    -1904030456L, -1000512884L, 1855375132L, 690301074L, -187446912L, 
    859867668L, 174613288L, -852615622L, -1791536688L, 926348652L, 
    2014374836L, -1508316142L, 959322592L, 1454783436L, 253323488L, 
    -1229299678L, 776457512L, -705155572L, -426910916L, -680008718L, 
    1497562864L, 1062044228L, -822514088L, -457096390L, -1724268048L, 
    1767108284L, 1096486164L, -1150904638L, -751773600L, -711690372L, 
    -1624949808L, 644500770L, 857294504L, -1480991860L, 1077759164L, 
    -2143598798L, -196740544L, 1224061108L, 1966979656L, 120106426L, 
    1588810256L, -1089161492L, 988611924L, 1706120466L, -1809299040L, 
    -934578484L, -1686094240L, 1316457410L, 20969868L, 1081413658L, 
    -420815729L, -1168456743L, 916653166L, -1446909956L, -619004563L, 
    1364891415L, -876116256L, -506350402L, -837270901L, -711816947L, 
    277863738L, 1587715448L, -1156950239L, -926216237L, 849975028L, 
    -2079094910L, -1315328489L, 1762657505L, -80109018L, 1786069796L, 
    -1865151531L, -1733375105L, 1164176920L, 1434236214L, 882936771L, 
    -437448187L, -1307645534L, -438801008L, 1719278905L, 311015915L, 
    1860950748L, 596762378L, 1107579391L, -1503217591L, -277655074L, 
    491256204L, 1570542941L, -1593584281L, -1636530544L, 1215309998L, 
    1022167387L, -275292867L, -574853206L, 107980872L, 798195825L, 
    1840860643L, 161056996L, 2011661330L, 237334503L, -1001007183L, 
    -1619621386L, -1904511980L, 1875520293L, 509635631L, 983530984L, 
    -1011377466L, -231292045L, -542897195L, 1695839154L, 1651402112L, 
    1019518313L, 231690715L, 1584838956L, -430752966L, -962103825L, 
    -293293959L, 679230222L, -1381486884L, 1891753293L, 1265815735L, 
    792709696L, 888738590L, -2095375893L, 1884149101L, -1290945574L, 
    1186672024L, 330863617L, -2020293197L, -183038764L, 1538611682L, 
    -479579017L, 636234177L, 485086022L, 1503542916L, 1392912437L, 
    11057183L, -1082753160L, -1910049194L, -695956765L, -933188443L, 
    -645860030L, -880491728L, -1146542247L, 504360139L, 287120700L, 
    -2119026326L, 434443167L, 835530281L, -259362626L, 917096876L, 
    1782781693L, 1930433095L, -1828880080L, -843421106L, 1446015611L, 
    -1067077155L, -1849395190L, -1817745112L, -611559535L, -414566013L, 
    -1274030460L, 1634616498L, -578972665L, 1968963665L, 834088918L, 
    270835380L, -89817403L, -579612657L, 1266991240L, 1696530854L, 
    -274728621L, 234687157L, 1187733522L, -129076768L, -394976183L, 
    1277358715L, -1236665524L, 1403399898L, -1749056817L, -325049703L, 
    -1046368594L, 1827122108L, 1328206893L, 1997683671L, 1106317856L, 
    -863095938L, -1351885493L, -732356787L, 894006650L, -1145755720L, 
    637828449L, 748859667L, 711215412L, -291060926L, -207162537L, 
    1171870369L, 664642406L, -1972626076L, -941553515L, 77973951L, 
    -975200936L, 1125000054L, -725687933L, -181705787L, -201262878L, 
    1843838288L, 276237433L, 425697195L, -1321589476L, 1118868042L, 
    -1023633857L, 94071433L, 142479006L, 1715252044L, -1402672355L, 
    1275165351L, -1696984624L, 582508604L)
